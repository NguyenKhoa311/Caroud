# AWS RDS PostgreSQL Setup Guide

H∆∞·ªõng d·∫´n chi ti·∫øt ƒë·ªÉ setup AWS RDS PostgreSQL cho Caroud Game.

## M·ª•c l·ª•c
1. [T·∫°o RDS Instance](#1-t·∫°o-rds-instance)
2. [C·∫•u h√¨nh Security Group](#2-c·∫•u-h√¨nh-security-group)
3. [K·∫øt n·ªëi t·ª´ Local](#3-k·∫øt-n·ªëi-t·ª´-local)
4. [C·∫•u h√¨nh Django](#4-c·∫•u-h√¨nh-django)
5. [Migration v√† Test](#5-migration-v√†-test)
6. [Troubleshooting](#6-troubleshooting)

---

## 1. T·∫°o RDS Instance

### B∆∞·ªõc 1.1: Truy c·∫≠p AWS Console
1. ƒêƒÉng nh·∫≠p AWS Console: https://console.aws.amazon.com/
2. T√¨m v√† ch·ªçn service **RDS**
3. Click **"Create database"**

### B∆∞·ªõc 1.2: Engine Configuration
- **Engine type**: PostgreSQL
- **Engine version**: PostgreSQL 15.5 (ho·∫∑c 14.x)
- **Templates**: 
  - ‚úÖ **Free tier** (cho testing/development)
  - üöÄ **Production** (cho production)

### B∆∞·ªõc 1.3: Settings
- **DB instance identifier**: `caroud-db` (ho·∫∑c t√™n t√πy ch·ªçn)
- **Master username**: `postgres` 
- **Master password**: T·∫°o password m·∫°nh
  - ‚ö†Ô∏è **L∆ØU √ù**: L∆∞u password n√†y l·∫°i, s·∫Ω c·∫ßn d√πng ƒë·ªÉ k·∫øt n·ªëi!

### B∆∞·ªõc 1.4: Instance Configuration
**Free Tier:**
- DB instance class: `db.t3.micro` (1 vCPU, 1GB RAM)
- Storage type: General Purpose SSD (gp2)
- Allocated storage: 20 GB

**Production:**
- DB instance class: `db.t3.small` ho·∫∑c cao h∆°n
- Storage type: General Purpose SSD (gp3)
- Allocated storage: 50 GB+
- ‚úÖ Enable storage autoscaling

### B∆∞·ªõc 1.5: Storage
- Allocated storage: **20 GB** (minimum)
- Storage autoscaling: 
  - ‚úÖ Enable (recommended)
  - Maximum storage threshold: 100 GB

### B∆∞·ªõc 1.6: Connectivity
- **Compute resource**: Don't connect to an EC2 compute resource (n·∫øu ch∆∞a c√≥ EC2)
- **Network type**: IPv4
- **Virtual private cloud (VPC)**: Default VPC
- **DB subnet group**: default
- **Public access**: 
  - ‚úÖ **Yes** (ƒë·ªÉ k·∫øt n·ªëi t·ª´ local - CH·ªà CHO DEV)
  - ‚ùå **No** (cho production, ch·ªâ EC2 trong VPC k·∫øt n·ªëi)
- **VPC security group**: 
  - Create new (s·∫Ω t·∫°o SG m·ªõi)
  - Security group name: `caroud-db-sg`
- **Availability Zone**: No preference

### B∆∞·ªõc 1.7: Database Authentication
- **Database authentication options**: Password authentication

### B∆∞·ªõc 1.8: Monitoring
- ‚úÖ Enable Enhanced monitoring (recommended cho production)
- ‚úÖ Enable Performance Insights (free tier c√≥ 7 days retention)

### B∆∞·ªõc 1.9: Additional Configuration
**QUAN TR·ªåNG:**
- **Initial database name**: `caroud` 
  - ‚ö†Ô∏è **B·∫ÆT BU·ªòC nh·∫≠p n√†y**, n·∫øu kh√¥ng s·∫Ω ph·∫£i t·∫°o database sau!
  
**Backup:**
- ‚úÖ Enable automated backups
- Backup retention period: 7 days (recommended)
- Backup window: Default

**Encryption:**
- ‚úÖ Enable encryption (recommended)
- Master key: (default) aws/rds

**Maintenance:**
- ‚úÖ Enable auto minor version upgrade

### B∆∞·ªõc 1.10: T·∫°o Database
1. Click **"Create database"**
2. ‚è±Ô∏è ƒê·ª£i 5-10 ph√∫t ƒë·ªÉ RDS instance ƒë∆∞·ª£c t·∫°o
3. Status s·∫Ω chuy·ªÉn t·ª´ "Creating" ‚Üí "Available"

---

## 2. C·∫•u h√¨nh Security Group

Sau khi RDS ƒë∆∞·ª£c t·∫°o, c·∫ßn m·ªü port PostgreSQL ƒë·ªÉ k·∫øt n·ªëi.

### B∆∞·ªõc 2.1: Truy c·∫≠p Security Group
1. V√†o RDS Dashboard
2. Click v√†o DB instance v·ª´a t·∫°o (`caroud-db`)
3. Tab **"Connectivity & security"**
4. Trong ph·∫ßn **"Security"**, click v√†o Security group ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng (vd: `caroud-db-sg`)

### B∆∞·ªõc 2.2: Th√™m Inbound Rule
1. Tab **"Inbound rules"**
2. Click **"Edit inbound rules"**
3. Click **"Add rule"**

**Cho Development (k·∫øt n·ªëi t·ª´ local):**
- Type: `PostgreSQL`
- Protocol: `TCP`
- Port range: `5432`
- Source: `My IP` (ho·∫∑c `0.0.0.0/0` - kh√¥ng khuy·∫øn kh√≠ch)
- Description: `Allow PostgreSQL from my IP`

**Cho Production (k·∫øt n·ªëi t·ª´ EC2):**
- Type: `PostgreSQL`
- Protocol: `TCP`
- Port range: `5432`
- Source: `Custom` ‚Üí ch·ªçn Security Group c·ªßa EC2
- Description: `Allow PostgreSQL from EC2`

4. Click **"Save rules"**

---

## 3. K·∫øt n·ªëi t·ª´ Local

### B∆∞·ªõc 3.1: L·∫•y Connection Information
1. V√†o RDS instance detail
2. Tab **"Connectivity & security"**
3. Copy c√°c th√¥ng tin:
   - **Endpoint**: `caroud-db.xxxxxx.us-east-1.rds.amazonaws.com`
   - **Port**: `5432`
   - **Database name**: `caroud`
   - **Master username**: `postgres`

### B∆∞·ªõc 3.2: Test k·∫øt n·ªëi b·∫±ng psql
```bash
# Install psql n·∫øu ch∆∞a c√≥ (macOS)
brew install postgresql

# Test connection
psql -h caroud-db.xxxxxx.us-east-1.rds.amazonaws.com \
     -U postgres \
     -d caroud \
     -p 5432

# Nh·∫≠p password khi ƒë∆∞·ª£c h·ªèi
# N·∫øu k·∫øt n·ªëi th√†nh c√¥ng, b·∫°n s·∫Ω th·∫•y prompt: caroud=>
```

### B∆∞·ªõc 3.3: Ki·ªÉm tra database
```sql
-- List all databases
\l

-- Connect to caroud database
\c caroud

-- List all tables (s·∫Ω r·ªóng ban ƒë·∫ßu)
\dt

-- Exit
\q
```

---

## 4. C·∫•u h√¨nh Django

### B∆∞·ªõc 4.1: Install Python Packages
```bash
cd /Users/hoangnv/Desktop/caroud/backend

# Activate virtual environment
source venv/bin/activate  # ho·∫∑c ./venv/bin/activate

# psycopg2 ƒë√£ ƒë∆∞·ª£c c√†i trong requirements.txt
# N·∫øu ch∆∞a c√≥:
pip install psycopg2-binary
```

### B∆∞·ªõc 4.2: T·∫°o file .env
```bash
# Copy t·ª´ example
cp .env.example .env

# Edit file .env
nano .env
```

### B∆∞·ªõc 4.3: C·∫≠p nh·∫≠t .env v·ªõi RDS credentials
```bash
# Django Settings
SECRET_KEY=your-secret-key-here
DEBUG=False
ALLOWED_HOSTS=localhost,127.0.0.1,your-domain.com

# AWS RDS PostgreSQL
DB_NAME=caroud
DB_USER=postgres
DB_PASSWORD=YOUR_RDS_MASTER_PASSWORD_HERE
DB_HOST=caroud-db.xxxxxx.us-east-1.rds.amazonaws.com
DB_PORT=5432

# Redis
REDIS_URL=redis://localhost:6379

# CORS
CORS_ALLOWED_ORIGINS=http://localhost:3000
```

### B∆∞·ªõc 4.4: Verify settings.py
File `caroud/settings.py` ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh ƒë·ªÉ ƒë·ªçc t·ª´ environment variables:
```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': os.getenv('DB_NAME', 'caro_game_db'),
        'USER': os.getenv('DB_USER', 'postgres'),
        'PASSWORD': os.getenv('DB_PASSWORD', 'postgres'),
        'HOST': os.getenv('DB_HOST', 'localhost'),
        'PORT': os.getenv('DB_PORT', '5432'),
    }
}
```

---

## 5. Migration v√† Test

### B∆∞·ªõc 5.1: Load environment variables
```bash
# V·ªõi python-dotenv, Django t·ª± ƒë·ªông load .env
# Ho·∫∑c export manually:
export $(cat .env | xargs)
```

### B∆∞·ªõc 5.2: Test database connection
```bash
cd backend

# Test connection
python manage.py dbshell

# N·∫øu k·∫øt n·ªëi th√†nh c√¥ng, b·∫°n s·∫Ω v√†o psql prompt
# Type \q ƒë·ªÉ tho√°t
```

### B∆∞·ªõc 5.3: Run migrations
```bash
# Make migrations (n·∫øu c√≥ thay ƒë·ªïi models)
python manage.py makemigrations

# Apply migrations
python manage.py migrate

# Expected output:
# Operations to perform:
#   Apply all migrations: admin, auth, contenttypes, game, matchmaking, sessions, users
# Running migrations:
#   Applying contenttypes.0001_initial... OK
#   Applying auth.0001_initial... OK
#   ...
```

### B∆∞·ªõc 5.4: T·∫°o superuser
```bash
python manage.py createsuperuser

# Nh·∫≠p th√¥ng tin:
# Username: admin
# Email: admin@caroud.com
# Password: ***
```

### B∆∞·ªõc 5.5: Test server
```bash
# Start Django server
python manage.py runserver

# Server s·∫Ω ch·∫°y tr√™n http://127.0.0.1:8000/
# Truy c·∫≠p admin: http://127.0.0.1:8000/admin/
```

### B∆∞·ªõc 5.6: Verify data trong RDS
```bash
# Connect to RDS
psql -h caroud-db.xxxxxx.us-east-1.rds.amazonaws.com \
     -U postgres \
     -d caroud

# Check tables
\dt

# Should see tables:
# - auth_user
# - game_match
# - users_customuser
# - etc.

# Count users
SELECT COUNT(*) FROM users_customuser;
```

---

## 6. Troubleshooting

### ‚ùå Error: Could not connect to server
**Nguy√™n nh√¢n:**
- Security Group ch∆∞a m·ªü port 5432
- Public access = No (kh√¥ng th·ªÉ k·∫øt n·ªëi t·ª´ ngo√†i VPC)
- Wrong endpoint

**Gi·∫£i ph√°p:**
1. Ki·ªÉm tra Security Group inbound rules
2. ƒê·∫£m b·∫£o Public access = Yes (cho dev)
3. Verify endpoint v√† credentials

### ‚ùå Error: password authentication failed
**Nguy√™n nh√¢n:**
- Sai password
- Sai username

**Gi·∫£i ph√°p:**
1. Reset master password trong RDS console:
   - RDS ‚Üí Database ‚Üí Modify
   - New master password
   - Apply immediately
2. C·∫≠p nh·∫≠t `.env` v·ªõi password m·ªõi

### ‚ùå Error: database "caroud" does not exist
**Nguy√™n nh√¢n:**
- Kh√¥ng nh·∫≠p "Initial database name" khi t·∫°o RDS

**Gi·∫£i ph√°p:**
```bash
# Connect to default postgres database
psql -h your-rds-endpoint -U postgres -d postgres

# Create database
CREATE DATABASE caroud;

# Grant permissions
GRANT ALL PRIVILEGES ON DATABASE caroud TO postgres;

# Exit and reconnect to caroud
\q
```

### ‚ùå Error: TimeoutError / Connection timed out
**Nguy√™n nh√¢n:**
- Network connectivity issues
- VPC/Subnet kh√¥ng c√≥ internet access

**Gi·∫£i ph√°p:**
1. Check security group
2. Check VPC route tables
3. Verify subnet c√≥ NAT gateway (n·∫øu private)

### ‚ùå Error: SSL connection required
**Nguy√™n nh√¢n:**
- RDS y√™u c·∫ßu SSL connection

**Gi·∫£i ph√°p:**
Update `settings.py`:
```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': os.getenv('DB_NAME'),
        'USER': os.getenv('DB_USER'),
        'PASSWORD': os.getenv('DB_PASSWORD'),
        'HOST': os.getenv('DB_HOST'),
        'PORT': os.getenv('DB_PORT'),
        'OPTIONS': {
            'sslmode': 'require',
        },
    }
}
```

---

## Best Practices

### üîí Security
1. **Kh√¥ng bao gi·ªù commit `.env` v√†o Git**
   - ƒê√£ c√≥ trong `.gitignore`
2. **S·ª≠ d·ª•ng IAM authentication** thay v√¨ password (advanced)
3. **Rotate password ƒë·ªãnh k·ª≥**
4. **Enable encryption at rest**
5. **Restrict Security Group** ch·ªâ cho ph√©p IP/SG c·∫ßn thi·∫øt

### üí∞ Cost Optimization
1. S·ª≠ d·ª•ng **Free Tier** cho development (`db.t3.micro`)
2. Stop RDS instance khi kh√¥ng d√πng (ƒë∆∞·ª£c free 7 days stopped)
3. Gi·∫£m backup retention n·∫øu kh√¥ng c·∫ßn (m·∫∑c ƒë·ªãnh 7 days)
4. Delete RDS khi kh√¥ng c√≤n d√πng ƒë·ªÉ tr√°nh ph√≠

### üöÄ Performance
1. Enable **Performance Insights** ƒë·ªÉ monitor
2. TƒÉng instance class n·∫øu CPU/Memory cao
3. S·ª≠ d·ª•ng **Read Replicas** cho read-heavy workload
4. Enable **Connection pooling** (pgBouncer) n·∫øu nhi·ªÅu connections

### üìä Monitoring
1. Enable **Enhanced Monitoring**
2. Setup **CloudWatch Alarms** cho:
   - High CPU usage (>80%)
   - Low storage space (<20%)
   - High number of connections
3. Check **RDS Events** th∆∞·ªùng xuy√™n

---

## Useful Commands

### psql Commands
```bash
# Connect
psql -h <endpoint> -U <username> -d <database>

# List databases
\l

# Connect to database
\c database_name

# List tables
\dt

# Describe table
\d table_name

# Show table data
SELECT * FROM table_name LIMIT 10;

# Exit
\q
```

### Django Management Commands
```bash
# Check database connection
python manage.py dbshell

# Show migrations
python manage.py showmigrations

# Create migrations
python manage.py makemigrations

# Apply migrations
python manage.py migrate

# Create superuser
python manage.py createsuperuser

# Dump data
python manage.py dumpdata > backup.json

# Load data
python manage.py loaddata backup.json
```

---

## Next Steps

Sau khi setup RDS th√†nh c√¥ng:

1. ‚úÖ **Deploy Backend l√™n EC2/ECS**
2. ‚úÖ **Setup Redis tr√™n AWS ElastiCache** (cho Django Channels)
3. ‚úÖ **Setup S3** cho static/media files
4. ‚úÖ **Setup CloudFront** CDN
5. ‚úÖ **Setup Route53** cho domain
6. ‚úÖ **Setup SSL Certificate** (AWS Certificate Manager)

---

## Resources

- [AWS RDS PostgreSQL Documentation](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_PostgreSQL.html)
- [Django PostgreSQL Notes](https://docs.djangoproject.com/en/5.0/ref/databases/#postgresql-notes)
- [psycopg2 Documentation](https://www.psycopg.org/docs/)

---

**L∆∞u √Ω:** H∆∞·ªõng d·∫´n n√†y ƒë∆∞·ª£c vi·∫øt cho AWS region `us-east-1`. N·∫øu s·ª≠ d·ª•ng region kh√°c, thay ƒë·ªïi endpoint cho ph√π h·ª£p.
